{% extends "base.html" %}

{% block title %}إنشاء حساب - موقع الفريلانسر{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header text-center">
                <h3><i class="fas fa-user-plus text-primary"></i> إنشاء حساب جديد</h3>
            </div>
            <div class="card-body">
<form method="POST" id="registerForm">
    <!-- Hidden Captcha Fields -->
    <input type="hidden" name="time_token" value="{{ time_token }}">
    <input type="hidden" name="timestamp" value="{{ timestamp }}">
    <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response">
    
    <!-- Honeypot Fields (مخفية للمستخدمين البشريين) -->
    <div style="position: absolute; left: -9999px;">
        <input type="text" name="website" tabindex="-1" autocomplete="off">
        <input type="text" name="url" tabindex="-1" autocomplete="off">
        <input type="text" name="homepage" tabindex="-1" autocomplete="off">
        <input type="text" name="company" tabindex="-1" autocomplete="off">
    </div>
    
    <div class="mb-3">
        <label for="email" class="form-label">البريد الإلكتروني</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="form-text">يجب استخدام Gmail أو Hotmail أو iCloud</div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">كلمة المرور</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                        <div class="form-text">6 أحرف على الأقل</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> إنشاء الحساب
                        </button>
                    </div>
                </form>
                <div class="text-center mt-3">
                    <p>لديك حساب بالفعل؟ <a href="{{ url_for('login') }}">سجل دخولك</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Google reCAPTCHA v3 -->
{% if config.RECAPTCHA_SITE_KEY %}
<script src="https://www.google.com/recaptcha/api.js?render={{ config.RECAPTCHA_SITE_KEY }}"></script>
<script>
document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    grecaptcha.ready(function() {
        grecaptcha.execute('{{ config.RECAPTCHA_SITE_KEY }}', {action: 'register'}).then(function(token) {
            document.getElementById('g-recaptcha-response').value = token;
            document.getElementById('registerForm').submit();
        });
    });
});
</script>
{% endif %}

<!-- أضف هذا الكود بعد السطر الموجود -->
<!-- JavaScript Challenge -->
<script>
// تحدي JavaScript بسيط
(function() {
    var challenge = document.createElement('input');
    challenge.type = 'hidden';
    challenge.name = 'js_challenge';
    challenge.value = btoa(Date.now().toString());
    document.getElementById('registerForm').appendChild(challenge);
})();
</script>

<script>
// Browser Automation Detection
(function() {
    const automationData = {
        webdriver: !!(navigator.webdriver || window.webdriver || document.documentElement.getAttribute('webdriver')),
        devtools: false,
        suspicious_plugins: 0,
        screen_inconsistency: false,
        no_mouse_movement: true
    };
    
    // فحص Developer Tools
    let devtools = {open: false, orientation: null};
    setInterval(function() {
        if (window.outerHeight - window.innerHeight > 200 || window.outerWidth - window.innerWidth > 200) {
            automationData.devtools = true;
        }
    }, 500);
    
    // فحص الـ plugins المشبوهة
    for (let i = 0; i < navigator.plugins.length; i++) {
        const plugin = navigator.plugins[i];
        if (plugin.name.toLowerCase().includes('automation') || 
            plugin.name.toLowerCase().includes('selenium') ||
            plugin.name.toLowerCase().includes('webdriver')) {
            automationData.suspicious_plugins++;
        }
    }
    
    // فحص تناسق حجم الشاشة
    if (screen.width !== window.screen.width || screen.height !== window.screen.height) {
        automationData.screen_inconsistency = true;
    }
    
    // تتبع حركة الماوس
    let mouseEvents = 0;
    let clickEvents = 0;
    let keyboardEvents = 0;
    let scrollEvents = 0;
    let startTime = Date.now();
    let typingSpeed = 0;
    let keyStrokes = 0;
    
    document.addEventListener('mousemove', function() {
        mouseEvents++;
        automationData.no_mouse_movement = false;
    });
    
    document.addEventListener('click', function() {
        clickEvents++;
    });
    
    document.addEventListener('keydown', function() {
        keyboardEvents++;
        keyStrokes++;
    });
    
    document.addEventListener('scroll', function() {
        scrollEvents++;
    });
    
    // تتبع توقيت ملء النموذج
    const formTiming = {};
    const emailField = document.getElementById('email');
    const passwordField = document.getElementById('password');
    
    if (emailField) {
        emailField.addEventListener('focus', function() {
            formTiming.email_focus = Date.now();
        });
        emailField.addEventListener('blur', function() {
            if (formTiming.email_focus) {
                formTiming.email_fill_time = Date.now() - formTiming.email_focus;
            }
        });
    }
    
    if (passwordField) {
        passwordField.addEventListener('focus', function() {
            formTiming.password_focus = Date.now();
        });
        passwordField.addEventListener('blur', function() {
            if (formTiming.password_focus) {
                formTiming.password_fill_time = Date.now() - formTiming.password_focus;
                // حساب سرعة الكتابة
                if (passwordField.value.length > 0) {
                    typingSpeed = (passwordField.value.length / (formTiming.password_fill_time / 1000)) * 60;
                }
            }
        });
    }
    
    // إضافة البيانات عند إرسال النموذج
    document.getElementById('registerForm').addEventListener('submit', function() {
        const interactionData = {
            mouse_events: mouseEvents,
            click_events: clickEvents,
            keyboard_events: keyboardEvents,
            scroll_events: scrollEvents,
            page_time: Date.now() - startTime,
            typing_speed: typingSpeed
        };
        
        // إضافة بيانات الأتمتة
        const automationInput = document.createElement('input');
        automationInput.type = 'hidden';
        automationInput.name = 'automation_check';
        automationInput.value = JSON.stringify(automationData);
        this.appendChild(automationInput);
        
        // إضافة بيانات التفاعل
        const interactionInput = document.createElement('input');
        interactionInput.type = 'hidden';
        interactionInput.name = 'interaction_data';
        interactionInput.value = JSON.stringify(interactionData);
        this.appendChild(interactionInput);
        
        // إضافة بيانات توقيت النموذج
        const timingInput = document.createElement('input');
        timingInput.type = 'hidden';
        timingInput.name = 'form_timing';
        timingInput.value = JSON.stringify(formTiming);
        this.appendChild(timingInput);
    });
})();
</script>
{% endblock %}
